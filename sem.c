#include <stdio.h>
#include <wait.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <sys/msg.h>
#include <sys/shm.h>
#include "dijkstra.h"
#define CLEF 0x00012347
#define CLEF2 0x00013347
#define CLEF3 0x00016347
#define CLE 1
#define CLE2 2
#define CLE3 3
#define CLE4 4
#define CLEM 5
int *rnd;
int *t1,*t2,it1,it2;
int imsg;
int *cpt,icpt;
int max=20;
int m=5,n=5,d1=0,f1=0,d2=0,f2=0;
int mutex,vide,plein,stop;
struct msgtext {
	long mtype ;
	int mtext;
} msg ;
//////////////////////////////////////
int article(int art){
	return art+1;
}
//////////////////////////////////////
void deposer(int *t,int k,int art,int c){
	int i;
	
		t[c]=art;
		printf("je suis le prod et j'ai deposer :%d\n" ,art);
		
	
}
//////////////////////////////////////
int  prelever(int *t,int k,int c){
	int i;int val=0;
	
	val=t[c];
	t[c]=0;return val;
         
      


}



///////////////////////////////////
void envoyermsg(int art){int i;

	msg.mtype = 1;
	msg.mtext=art;
	/* on envoie le message a la file */
	if(msgsnd(imsg,&msg,sizeof(int),0) == -1){
		perror("impossible d'envoyer le message") ;
		exit(-1) ;
	}


 

}



//////////////////////////////////////
void prod(){
	int art=0,c1=0,c2=0;
        
	while(1){
		
		int i;
                sleep(2) ;
		

		art=article(art);

                P(vide);

		P(mutex);


		//printf("cpt=%d m=%d\n",*cpt,m);

		if(*cpt<m){
			V(mutex);

			deposer(t1,m,art,c1);c1++;
                         if(c1==m) {c1 =0 ; }  
			P(mutex);

			*cpt=(*cpt)+1;

			V(mutex);
		}else{
			V(mutex);

			deposer(t2,n,art,c2);c2++;
			if(c2==n) {c2 =0 ; }  
		}
		V(plein);

                printf("t1 ");
		for(i=0;i<n;i++){
		printf("%2d ",t1[i]);
		}printf("\n");
		
                  printf("t2 ");
		for(i=0;i<m;i++){
			printf("%2d ",t2[i]);

		}printf("\n");
}
}
//////////////////////////////////////
void consprod(){
int i =0 ;
	int art,c1=0,c2=0;
	while(1){

       sleep(4);
		P(plein);
		P(mutex);
		if(*cpt>0){
			V(mutex);
                      
			art=prelever(t1,m,c1);c1++;
                            if(c1==m) {c1 =0 ;}
			
			
                        P(mutex);
			*cpt=(*cpt)-1;
			
                        V(mutex);

		}else{
			V(mutex);
			art=prelever(t2,n,c2);c2++;
                        if(c2==n) {c2 =0 ;}
			
			
		}

                     V(vide); 
	envoyermsg(art);

printf("				   je suis le consprod et j'ai enfiler :%d\n" , art);

printf("				   t1 ");
for(i=0;i<n;i++){
printf("%2d ",t1[i]);
}printf("\n");

  printf("				   t2 ");
for(i=0;i<m;i++){
	printf("%2d ",t2[i]);

}printf("\n");
}
}
//////////////////////////////////////
void cons(){int i;
	while(1){
		
		sleep(4);

		if((msgrcv(imsg,&msg,sizeof(int),0,0)) !=-1)
		{
			printf("									je suis cons et j ai recu %d\n",msg.mtext);
		}
	
	}
}


/////////////////
void sup(){
shmdt(t1);
shmctl(it1,IPC_RMID,NULL);
shmdt(t2);
shmctl(it2,IPC_RMID,NULL);
shmdt(cpt);
shmctl(icpt,IPC_RMID,NULL);

}



//////////////////////////////////////
int main()
{	rnd=malloc(sizeof(int));*rnd=0;
	//t1
	/* création t1 ou lien avec la zone partagée */
	it1 = shmget(CLEF, m*sizeof(int), 0700 | IPC_CREAT); 
	if (it1 == -1) { perror("shmget"); return (EXIT_FAILURE); }
	/* montage en mémoire */
	t1 = shmat(it1, NULL, 0);
	//t2
	/* création t2 ou lien avec la zone partagée */
	it2 = shmget(CLEF2, n*sizeof(int), 0700 | IPC_CREAT); 
	if (it2 == -1) { perror("shmget"); return (EXIT_FAILURE); }
	/* montage en mémoire */
	t2 = shmat(it2, NULL, 0);
	//cpt
	/* création cpt ou lien avec la zone partagée */
	icpt = shmget(CLEF3, sizeof(int), 0700 | IPC_CREAT);
	if (icpt == -1) { perror("shmget"); return (EXIT_FAILURE); }
	/* montage en mémoire */
	cpt = shmat(icpt, NULL, 0);
	*cpt=0;
	//message
	if((imsg=msgget(CLEM,IPC_CREAT)) == -1){
		perror("Echec de msgget") ;
		exit(1) ;
	}
	//mutex
	mutex = sem_create(CLE, 1) ;
	//vide
	vide = sem_create(CLE2, m+n/*+2430 2049*/) ;
	//plein
	plein = sem_create(CLE3, 0) ;
	//stop
	stop = sem_create(CLE4, 0) ;
	//initialisation
	int i;
	for(i=0;i<n;i++){
		t1[i]=0;
	}
	for(i=0;i<n;i++){
		t2[i]=0;
	}

int id1 , id2 , id3;
 id1 = fork() ;
  if(id1==0){
   prod();
  exit(0);
}

 id2 = fork() ;
if(id2==0){
consprod() ;
exit(0);
}
id3 = fork() ;
if(id3==0){
cons() ;
exit(0);
}
/*
sup();
*/
wait(0);
wait(0);
wait(0);
	
	return (EXIT_SUCCESS);
}
